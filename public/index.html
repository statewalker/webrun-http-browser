<!DOCTYPE html>
<html>

<head>
  <meta charset='utf-8'>
  <meta http-equiv='X-UA-Compatible' content='IE=edge'>
  <title>Page Title</title>
  <meta name='viewport' content='width=device-width, initial-scale=1'>
</head>

<body>
  <div id="info"></div>
  <div id="messages" style="display: block; border: 1px solid blue; padding: 0.5em;"></div>
  <div id="counter"></div>

  <button id="button">Load Data</button>
  <div id="panel"></div>

  <script type="module">
    import newHttpAdapter from "./index.js";
    import { v4 as uuidv4 } from "https://unpkg.com/uuid@9.0.0/dist/esm-browser/index.js";

    document.addEventListener("DOMContentLoaded", main);
    // Promise.resolve().then(main).catch(console.error);

    async function main() {

      const key = uuidv4();
      const prefix = `/${key}/`; // "/sw-http/"
      const httpAdapter= newHttpAdapter({ key });
      await httpAdapter.start();

      function showMessage(message) {
        const elm = document.body.querySelector("#messages");
        elm.innerHTML = message;
      }
      showMessage("No messages yet... :(")

      window.addEventListener("message", receiveMessage, false);
      function receiveMessage(event) {
        // const [port] = event.ports || [];
        if (event.ports) {
          event.ports[0]?.postMessage("Message back from the IFrame");
          console.log('EVENT WITH PORTS:', event, event.ports);
        }
        showMessage(`Message from "${event.origin}". Data:"${JSON.stringify(event.data)}" !`)
      }

      const registration = await httpAdapter.register(prefix, async (request) => {
        const requestUrl = new URL(request.url);
        const elm = document.querySelector("#counter");
        elm.innerHTML = `URL: ${requestUrl}<br />Last Request Time: ${Date.now()}`;

        const { pathname } = requestUrl;
        if (request.method === 'GET' && pathname.match(/\.js$/)) {
          const code = `export default function sayHello() { return 'Hello, there ${Date.now()}!'; }`
          return new Response(code, {
            headers: {
              "Content-Type": "text/javascript",
              "X-Foo-Bar": "baz"
            }
          })
        } else if (request.method === 'POST') {
          const body = await request.text();
          console.log('[client] Body:', body);
          const obj = {
            url: request.url + '',
            method: request.method,
            message: body.toUpperCase(),
            headers: Object.fromEntries([...request.headers])
          }
          return new Response(JSON.stringify(obj, null, 2), {
            headers: {
              "Content-Type": "application/json",
              "X-Foo-Bar": "baz"
            }
          })
        }

        return new Response("Hello, world " + Date.now(), {
          headers: {
            "Content-Type": "text/plain",
            "X-Foo-Bar": "baz"
          }
        })

      })

      const { baseUrl } = registration;

      const btn = document.querySelector("#button");
      const panel = document.querySelector("#panel");
      const info = document.querySelector("#info").innerText = baseUrl;

      btn.addEventListener("click", async (ev) => {
        ev.preventDefault();
        ev.stopPropagation();
        const fetchUrl = new URL("./data-calls.js", baseUrl) + '';
        console.log('Fetch URL:', fetchUrl);
        const res = await fetch(fetchUrl, {
          // method: 'POST',
          // body: "Hello, there!",
          // headers: {
          //   "Content-Type": "text/plain"
          // }
        });
        const content = await res.text();
        panel.innerText = content;
      })
      await new Promise(r => setTimeout(r, 2000));

      // (async function () {
      //   try {
      //     const scriptUrl = new URL("./xyz/sayHello.js", baseUrl) + '';
      //     console.log('>TF', scriptUrl);
      //     await new Promise(r => setTimeout(r, 2000));
      //     const { default: sayHello } = await import(scriptUrl);
      //     console.log(sayHello);
      //     console.log(sayHello())
      //   } catch (error) {
      //     console.error(error);
      //   }
      // })();


    }

  </script>

</body>

</html>